<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eduardo Ferreira Moura — Portafolio en un mapa</title>
  <meta name="description" content="Portafolio interactivo en mapa: cooperación, desafíos organizacionales, políticas públicas y trabajos de conservación/restauración." />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="assets/favicon.png" />

  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b0f1a; --panel:#0e1526; --ink:#e5e7eb; --muted:#a5b4fc; --line:#1f2a44; --card:#111827;
      --coop:#60a5fa;  /* cooperación */
      --org:#a78bfa;   /* organizacional */
      --pol:#34d399;   /* políticas públicas */
      --mano:#f59e0b;  /* manos a la obra */
      --star:#f43f5e;  /* destacado OEI */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:linear-gradient(160deg, var(--bg), #0a0f1d 40%, #0b1224 100%);
      color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    #app{display:grid; grid-template-rows:auto 1fr; height:100%}

    header{
      position:sticky; top:0; z-index:40;
      background:linear-gradient(180deg, rgba(11,15,26,.95), rgba(11,15,26,.75));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1160px; margin:0 auto; padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand{font-weight:700}
    .sub{font-size:.9rem; color:#c7d2fe}
    .wrap a{color:#93c5fd; text-decoration:none}
    .wrap a:hover{text-decoration:underline}

    #map{width:100%; height:100%}

    /* Painel (só legenda, sem checkboxes) */
    .panel{
      position:absolute; top:12px; left:12px; z-index:500;
      background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px;
      min-width:240px; box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .panel h3{margin:0 0 8px; font-size:1rem}
    .legend{display:grid; gap:8px}
    .legend-row{display:flex; align-items:center; gap:10px}
    .dot{width:12px; height:12px; border-radius:999px; border:1px solid rgba(255,255,255,.2)}
    .dot.coop{background:var(--coop)}
    .dot.org{background:var(--org)}
    .dot.pol{background:var(--pol)}
    .dot.mano{background:var(--mano)}
    .star-badge{
      display:inline-flex; align-items:center; justify-content:center;
      width:14px; height:14px; border-radius:3px; font-weight:700; line-height:1;
      background:var(--star); color:#fff;
    }

    /* Tooltip */
    .leaflet-tooltip.experience{
      background:rgba(17,24,39,.98); color:#e5e7eb; border:1px solid #334155;
      border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35)
    }
    .balloon{display:grid; grid-template-columns:80px 1fr; gap:10px; max-width:320px}
    .balloon img{width:80px; height:80px; object-fit:cover; border-radius:8px}
    .balloon h4{margin:0 0 2px; font-size:1rem}
    .balloon p{margin:0; font-size:.9rem; color:#cbd5e1}
    .balloon .tag{margin-top:6px; font-size:.78rem; opacity:.9}

    /* Marcadores */
    .pin{width:16px; height:16px; border-radius:50%; border:2px solid #0b0f1a;
      box-shadow:0 0 0 2px rgba(0,0,0,.25)}
    .pin.coop{background:var(--coop)}
    .pin.org{background:var(--org)}
    .pin.pol{background:var(--pol)}
    .pin.mano{background:var(--mano)}

    /* Etiqueta ano */
    .badge{position:absolute; right:12px; bottom:12px; z-index:500;
      background:rgba(17,24,39,.85); border:1px solid var(--line);
      padding:6px 10px; border-radius:999px; font-size:.85rem; color:#cbd5e1}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="wrap">
        <div>
          <div class="brand">Eduardo Ferreira Moura</div>
          <div class="sub">Portafolio en un mapa · Cooperación · Organizacional · Políticas · Manos a la obra</div>
        </div>
        <nav>
          <a href="mailto:SEU_EMAIL_AQUI">Contacto</a>
        </nav>
      </div>
    </header>

    <div id="map"></div>

    <!-- Painel com legenda (sem filtros) -->
    <div class="panel" id="panel">
      <h3>Explorar</h3>
      <div class="legend">
        <div class="legend-row"><span class="dot coop"></span> Cooperación internacional</div>
        <div class="legend-row"><span class="dot org"></span> Desafíos organizacionales</div>
        <div class="legend-row"><span class="dot pol"></span> Políticas públicas</div>
        <div class="legend-row"><span class="dot mano"></span> Manos a la obra</div>
        <div class="legend-row"><span class="star-badge">★</span> Destacado para OEI</div>
      </div>
      <div style="margin-top:10px; font-size:.85rem; color:#cbd5e1">
        Datos: <code>assets/experiences.csv</code>
      </div>
    </div>

    <div class="badge">© <span id="y"></span> EFM</div>
  </div>

  <script>
    // ====== Configurações ======
    const CATEGORIES = {
      coop: { label: 'Cooperación', color: 'var(--coop)' },
      org:  { label: 'Organizacional', color: 'var(--org)' },
      pol:  { label: 'Políticas', color: 'var(--pol)' },
      mano: { label: 'Manos', color: 'var(--mano)' }
    };

    // Mapa sem botões +/-, focado em Iberoamérica por padrão
    const map = L.map('map', { zoomControl: false, attributionControl: true })
      .setView([15, -40], 3);

    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:36 });
    map.addLayer(cluster);

    // Gestão de marcadores / rotação
    const allMarkers = [];
    const rotationTimers = new Map(); // marker -> interval id

    // Ícone: estrela para destacados; círculo por categoria para demais
    function markerIcon(cat, starred){
      if (starred) {
        return L.divIcon({
          className: '',
          html: `
            <div style="width:20px;height:20px;display:grid;place-items:center;
                        filter:drop-shadow(0 0 2px rgba(0,0,0,.35));">
              <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                <path d="M12 2l2.9 6.3 6.8.6-5.1 4.4 1.6 6.7-6.2-3.7-6.2 3.7 1.6-6.7-5.1-4.4 6.8-.6L12 2z"
                      fill="var(--star)" stroke="#0b0f1a" stroke-width="1"></path>
              </svg>
            </div>`,
          iconSize:[20,20], iconAnchor:[10,10]
        });
      }
      return L.divIcon({
        className: '',
        html: `<span class="pin ${cat}" style="background:${CATEGORIES[cat].color}"></span>`,
        iconSize:[16,16], iconAnchor:[8,8]
      });
    }

    // Tooltip HTML com suporte a múltiplas imagens
    function balloonHTML(rec, ttId){
      const imgs = Array.isArray(rec._imgs) ? rec._imgs : [];
      const imgTag = imgs.length ? `<img id="${ttId}_img" src="assets/${imgs[0]}" alt="${rec.title}">` : '';
      const star = rec.star === true ? ' ★' : '';
      const catLabel = CATEGORIES[rec.category]?.label || rec.category;
      return `<div class="balloon">${imgTag}<div><h4>${rec.title}${star}</h4><p>${rec.text || ''}</p><div class="tag">${rec.city || ''}${rec.country? ', '+rec.country:''} · ${catLabel}</div></div></div>`;
    }

    // Utilitários
    function toNum(v){
      if (v == null) return NaN;
      return parseFloat(String(v).trim().replace(',', '.'));
    }
    function normCat(v){
      const s = String(v||'').trim().toLowerCase();
      if (!s) return '';
      if (['coop','cooperacion','cooperación'].some(k=>s.startsWith(k))) return 'coop';
      if (['org','organiz','organizacional','organizational'].some(k=>s.startsWith(k))) return 'org';
      if (['pol','politica','política','publicas','públicas'].some(k=>s.startsWith(k))) return 'pol';
      if (['mano','manos','obra','restaur'].some(k=>s.startsWith(k))) return 'mano';
      return s;
    }

    // Carregamento do CSV
    Papa.parse('assets/experiences.csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res)=>{
        const rows = res.data;
        let kept = 0, dropped = 0;

        rows.forEach((r, idx)=>{
          const lat = toNum(r.lat), lon = toNum(r.lon);
          const cat = normCat(r.category);
          if (!isFinite(lat) || !isFinite(lon) || !CATEGORIES[cat]) {
            dropped++;
            console.warn('[skip]', r.title || r, {lat, lon, cat});
            return;
          }

          // imagens: lista (| ; ,) ou fallback single
          let imgs = [];
          if (r.images && String(r.images).trim()) {
            imgs = String(r.images).split(/\||;|,/).map(s=>s.trim()).filter(Boolean);
          }
          if ((!imgs || imgs.length===0) && r.image) {
            imgs = [String(r.image).trim()];
          }

          const starred = String(r.star||'').trim().toLowerCase();
          const isStar = (['1','true','yes','y','★','*'].includes(starred));

          const m = L.marker([lat, lon], { icon: markerIcon(cat, isStar) });
          m.rec = { ...r, category: cat, star: isStar, _imgs: imgs };
          const ttId = `tt_${idx}_${Date.now()}`;
          m._ttId = ttId;
          m.bindTooltip(balloonHTML(m.rec, ttId), {
            permanent:false, direction:'top', className:'experience', sticky:true, opacity:0.98
          });

          m.on('tooltipopen', ()=> startImageRotation(m));
          m.on('tooltipclose', ()=> stopImageRotation(m));
          m.on('click', ()=> m.openTooltip());

          cluster.addLayer(m);
          allMarkers.push(m);
          kept++;
        });

        if (kept > 0) fitToData();
        else {
          console.error('Nenhum marcador válido carregado. Verifique CSV/categorias/latlon.');
          map.setView([15, -40], 3); // fallback
        }
      }
    });

    function fitToData(){
      if (allMarkers.length){
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([15, -40], 3);
      }
    }

    // Rotação de imagens enquanto o tooltip está aberto
    function startImageRotation(marker){
      stopImageRotation(marker);
      const imgs = marker.rec._imgs || [];
      if(imgs.length <= 1) return;
      let idx = 0;
      const imgEl = document.getElementById(`${marker._ttId}_img`);
      if(!imgEl) return;
      const id = setInterval(()=>{
        idx = (idx + 1) % imgs.length;
        imgEl.src = `assets/${imgs[idx]}`;
      }, 1400);
      rotationTimers.set(marker, id);
    }
    function stopImageRotation(marker){
      const id = rotationTimers.get(marker);
      if(id){ clearInterval(id); rotationTimers.delete(marker); }
    }

    // Ano no rodapé
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <!--
  ==========================
  FORMATO DEL CSV (assets/experiences.csv)
  ==========================
  id,city,country,lat,lon,category,title,text,image,images,star

  Notas:
  - Usa **images** para varias imágenes (separadas por | ; ,). `image` (singular) es opcional como fallback.
  - category ∈ {coop, org, pol, mano} (se normaliza: “cooperación”, “organizacional”, etc. também funcionam).
  - star: 1/true/yes/★ para destacar experiencias clave para OEI.
  - Archivos de imagen deben estar en /assets/.
  - Múltiples experiencias en la misma ciudad se manejan por clustering automáticamente.
  -->
</body>
</html>
