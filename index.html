<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eduardo Ferreira Moura — Portafolio (Mapa)</title>
  <meta name="description" content="Portafolio interactivo en un mapa: cooperación internacional, desafíos organizacionales, políticas públicas y trabajos de conservación/restauración." />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="assets/favicon.png" />
  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#0e1526; --ink:#e5e7eb; --muted:#a5b4fc; --line:#1f2a44; --card:#111827;
      --coop:#60a5fa;       /* cooperación */
      --org:#a78bfa;        /* organizacional */
      --pol:#34d399;        /* políticas públicas */
      --mano:#f59e0b;       /* manos a la obra */
      --star:#f43f5e;       /* destacado OEI */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink)}
    #app{display:grid; grid-template-rows:auto 1fr; height:100%}
    header{position:sticky; top:0; z-index:40; background:linear-gradient(180deg, rgba(11,15,26,.95), rgba(11,15,26,.75)); border-bottom:1px solid var(--line)}
    .wrap{max-width:1160px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand{font-weight:700}
    .sub{font-size:.9rem; color:#c7d2fe}

    #map{width:100%; height:100%}

    /* Control panel */
    .panel{position:absolute; top:12px; left:12px; z-index:500; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px; min-width:260px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h3{margin:0 0 8px; font-size:1rem}
    .legend{display:grid; gap:8px}
    .legend-row{display:flex; align-items:center; gap:10px}
    .dot{width:12px; height:12px; border-radius:999px; border:1px solid rgba(255,255,255,.2)}
    .dot.coop{background:var(--coop)}
    .dot.org{background:var(--org)}
    .dot.pol{background:var(--pol)}
    .dot.mano{background:var(--mano)}
    .dot.star{background:var(--star)}
    .filters{margin-top:10px; display:grid; gap:6px; font-size:.95rem}
    .filters label{display:flex; align-items:center; gap:8px; cursor:pointer}

    /* Tooltip (hover balloon) */
    .leaflet-tooltip.experience{background:rgba(17,24,39,.98); color:#e5e7eb; border:1px solid #334155; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .balloon{display:grid; grid-template-columns:80px 1fr; gap:10px; max-width:320px}
    .balloon img{width:80px; height:80px; object-fit:cover; border-radius:8px}
    .balloon h4{margin:0 0 2px; font-size:1rem}
    .balloon p{margin:0; font-size:.9rem; color:#cbd5e1}
    .balloon .tag{margin-top:6px; font-size:.78rem; opacity:.9}

    /* Custom marker */
    .pin{width:16px; height:16px; border-radius:50%; border:2px solid #0b0f1a; box-shadow:0 0 0 2px rgba(0,0,0,.25)}
    .pin.coop{background:var(--coop)}
    .pin.org{background:var(--org)}
    .pin.pol{background:var(--pol)}
    .pin.mano{background:var(--mano)}
    .pin.star{box-shadow:0 0 0 2px rgba(0,0,0,.25), 0 0 0 4px rgba(244,63,94,.35)}

    /* Footer badge */
    .badge{position:absolute; right:12px; bottom:12px; z-index:500; background:rgba(17,24,39,.85); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:.85rem; color:#cbd5e1}

    /* Responsive small */
    @media(max-width:640px){.panel{min-width:220px}}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="wrap">
        <div>
          <div class="brand">Eduardo Ferreira Moura</div>
          <div class="sub">Portafolio en un mapa · Cooperación · Organizacional · Políticas · Manos a la obra</div>
        </div>
        <nav>
          <a href="mailto:SEU_EMAIL_AQUI" style="color:#93c5fd">Contacto</a>
        </nav>
      </div>
    </header>

    <div id="map"></div>
    <div class="panel" id="panel">
      <h3>Explorar</h3>
      <div class="legend">
        <div class="legend-row"><span class="dot coop"></span> Cooperación internacional</div>
        <div class="legend-row"><span class="dot org"></span> Desafíos organizacionales</div>
        <div class="legend-row"><span class="dot pol"></span> Políticas públicas</div>
        <div class="legend-row"><span class="dot mano"></span> Manos a la obra</div>
        <div class="legend-row"><span class="dot star"></span> Destacado para OEI</div>
      </div>
      <div class="filters">
        <label><input type="checkbox" data-cat="coop" checked> Cooperación</label>
        <label><input type="checkbox" data-cat="org" checked> Organizacional</label>
        <label><input type="checkbox" data-cat="pol" checked> Políticas</label>
        <label><input type="checkbox" data-cat="mano" checked> Manos</label>
        <label><input type="checkbox" id="onlyStar"> Sólo destacados (★)</label>
      </div>
      <div style="margin-top:10px; font-size:.85rem; color:#cbd5e1">Datos: <code>assets/experiences.csv</code></div>
    </div>

    <div class="badge">© <span id="y"></span> EFM</div>
  </div>

  <script>
    // ====== CONFIG ======
    const CATEGORIES = {
      coop: { label: 'Cooperación', color: 'var(--coop)' },
      org:  { label: 'Organizacional', color: 'var(--org)' },
      pol:  { label: 'Políticas', color: 'var(--pol)' },
      mano: { label: 'Manos', color: 'var(--mano)' }
    };

    const map = L.map('map', { zoomControl: true, attributionControl: true }).setView([10, -30], 2);
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Clustering para manejar múltiples experiencias por ciudad
    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:36 });
    map.addLayer(cluster);

    // Estado de filtros
    const activeCats = new Set(['coop','org','pol','mano']);
    let onlyStar = false;

    // Crear icono circular por categoría
    function markerIcon(cat, starred){
      const extra = starred ? ' star' : '';
      return L.divIcon({ className: '', html: `<span class="pin ${cat}${extra}" style="background:${CATEGORIES[cat].color}"></span>`, iconSize:[16,16], iconAnchor:[8,8] });
    }

    // Balloon (tooltip HTML)
    function balloonHTML(rec){
      const img = rec.image ? `<img src="assets/${rec.image}" alt="${rec.title}">` : '';
      const star = rec.star === '1' || rec.star === 'true' ? ' ★' : '';
      const catLabel = CATEGORIES[rec.category]?.label || rec.category;
      return `<div class="balloon">${img}<div><h4>${rec.title}${star}</h4><p>${rec.text || ''}</p><div class="tag">${rec.city || ''}${rec.country? ', '+rec.country:''} · ${catLabel}</div></div></div>`;
    }

    // Gestión de marcadores para filtrar luego
    const allMarkers = [];

    // Cargar CSV de experiencias
    Papa.parse('assets/experiences.csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res)=>{
        const rows = res.data;
        rows.forEach((r, idx)=>{
          const lat = parseFloat(r.lat), lon = parseFloat(r.lon);
          const cat = (r.category||'').trim();
          if(!isFinite(lat) || !isFinite(lon) || !CATEGORIES[cat]) return;
          const starred = String(r.star||'').trim().toLowerCase();
          const isStar = (starred === '1' || starred === 'true' || starred === 'yes' || starred === 'y');
          const m = L.marker([lat, lon], { icon: markerIcon(cat, isStar) });
          m.rec = { ...r, category: cat, star: isStar };
          m.bindTooltip(balloonHTML(m.rec), { permanent:false, direction:'top', className:'experience', sticky:true, opacity:0.98 });
          m.on('click', ()=>{ m.openTooltip(); });
          cluster.addLayer(m);
          allMarkers.push(m);
        });
        applyFilters();
        fitToData();
      }
    });

    function applyFilters(){
      allMarkers.forEach(m=>{
        const okCat = activeCats.has(m.rec.category);
        const okStar = onlyStar ? m.rec.star : true;
        if(okCat && okStar){
          if(!cluster.hasLayer(m)) cluster.addLayer(m);
        } else {
          if(cluster.hasLayer(m)) cluster.removeLayer(m);
        }
      });
    }

    function fitToData(){
      const group = L.featureGroup(allMarkers);
      if(allMarkers.length){ map.fitBounds(group.getBounds().pad(0.2)); }
    }

    // Filtros UI
    document.querySelectorAll('.filters [data-cat]').forEach(cb=>{
      cb.addEventListener('change', e=>{
        const cat = e.target.getAttribute('data-cat');
        if(e.target.checked) activeCats.add(cat); else activeCats.delete(cat);
        applyFilters();
      });
    });
    document.getElementById('onlyStar').addEventListener('change', e=>{ onlyStar = e.target.checked; applyFilters(); });

    // Year badge
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <!--
  ==========================
  FORMATO DEL CSV (assets/experiences.csv)
  ==========================
  id,city,country,lat,lon,category,title,text,image,star
  1,Valencia,España,39.4699,-0.3763,coop,UNESCO/IPHAN – Mapa de riesgos,"Diseño del mapa coroplético y repositorio público; integración de capas SICG/IPHAN, IBGE, CEMADEN, S2ID.",coop_1.jpg,1
  2,Rio de Janeiro,Brasil,-22.9068,-43.1729,pol,Fiocruz – Sostenibilidad,"Diagnósticos en laboratorios, hub OCM/ICCROM, implementación de buenas prácticas.",pol_1.jpg,0
  3,Florianópolis,Brasil,-27.5949,-48.5482,org,IPHAN/SC – Planeamiento,"BSC, evaluación 360, manuales operativos y mejora de comunicación interna.",org_1.jpg,1
  4,Belo Horizonte,Brasil,-19.9167,-43.9345,mano,Obras en estuco – Iglesia Sagrado Coração,"Conservación en obra, protocolos de seguridad y documentación técnica.",obra_1.jpg,0
  5,Brasília,Brasil,-15.7939,-47.8828,pol,MinC – Análisis de propuestas PRONAC,"Evaluación técnica en patrimonio cultural, humanidades, museos y memoria.",pol_2.jpg,0

  Notas:
  - category ∈ {coop, org, pol, mano}
  - star: 1/true/yes para destacar experiencias clave para OEI.
  - image: nombre de archivo dentro de /assets/ (opcional).
  - múltiples experiencias en la misma ciudad se manejan por clustering automáticamente.
  -->
</body>
</html>
